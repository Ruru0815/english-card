<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Dictionary & Project Manager</title>
    <style>
        :root {
            --primary: #1d4ed8;
            --secondary: #f1f5f9;
            --text-main: #111827;
            --success: #22c55e;
            --error: #ef4444;
            --save-btn-bg: #e2e8f0;
            --save-btn-color: #64748b;
            --saved-bg: #dcfce7;
            --saved-color: #15803d;
            --font-serif: 'Merriweather', serif;
            --font-sans: 'Segoe UI', Roboto, sans-serif;
        }

        body {
            font-family: var(--font-sans);
            margin: 0;
            background-color: #fff;
            color: var(--text-main);
            height: 100vh;
            overflow-x: hidden;
            transition: box-shadow 0.3s ease;
        }

        .glow-success { box-shadow: inset 0 0 50px var(--success) !important; }
        .glow-error { box-shadow: inset 0 0 50px var(--error) !important; }

        /* Navbar */
        .navbar {
            background: #fff; border-bottom: 1px solid #e5e7eb; padding: 15px 40px;
            display: flex; justify-content: space-between; align-items: center;
            position: fixed; top: 0; width: 100%; box-sizing: border-box; z-index: 100;
        }
        .logo { font-family: var(--font-serif); font-weight: 900; font-size: 24px; color: var(--primary); }
        
        .nav-actions { display: flex; align-items: center; gap: 12px; }
        .nav-btn {
            background: white; border: 1px solid #e5e7eb; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;
            display: flex; align-items: center; gap: 8px; transition: all 0.2s; font-size: 14px;
            text-decoration: none; color: var(--text-main);
        }
        .nav-btn:hover { background: var(--secondary); }
        .btn-final { background-color: #eab308; color: black; border: 1px solid #ca8a04; }
        .btn-final:hover { background-color: #ca8a04; }
        .badge { background: var(--primary); color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; }

        /* Sidebar */
        .sidebar {
            position: fixed; top: 0; right: -350px; width: 320px; height: 100vh; background: #f9fafb;
            border-left: 1px solid #e5e7eb; transition: right 0.3s ease; z-index: 200;
            display: flex; flex-direction: column; padding: 20px; box-sizing: border-box;
            box-shadow: -5px 0 15px rgba(0,0,0,0.05);
        }
        .sidebar.open { right: 0; }
        
        /* Project Controls in Sidebar */
        .project-controls {
            background: white; border: 1px solid #e5e7eb; padding: 10px; border-radius: 8px; margin-bottom: 15px;
        }
        .project-label { font-size: 12px; color: #666; margin-bottom: 5px; font-weight: bold; }
        .project-row { display: flex; gap: 5px; }
        .project-select {
            flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 4px; outline: none; font-size: 14px;
        }
        .btn-add-project {
            padding: 5px 10px; background: var(--secondary); border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        .btn-add-project:hover { background: #e2e8f0; }

        .sidebar-btn {
            width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 10px; display: block; text-align: center; text-decoration: none; font-size: 14px;
        }
        .btn-test { background: var(--text-main); color: white; }

        .list-item { background: white; border: 1px solid #e5e7eb; padding: 10px; margin-bottom: 8px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; }

        /* Main View */
        .container { margin-top: 80px; max-width: 800px; margin-left: auto; margin-right: auto; padding: 20px; }
        .search-input { width: 100%; padding: 20px; font-size: 20px; border: 2px solid #e5e7eb; border-radius: 8px; outline: none; }
        .entry-container { display: none; margin-top: 30px; }
        
        /* Â≠óÂÖ∏Ê®ôÈ†≠ËàáÂÑ≤Â≠òÊåâÈàï */
        .entry-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .word-group { display: flex; align-items: center; gap: 15px; }
        .headword { font-family: var(--font-serif); font-size: 48px; font-weight: 700; margin: 0; }
        
        /* Save Button with Animation */
        .btn-save-word {
            display: flex; align-items: center; gap: 6px;
            padding: 8px 16px; border-radius: 20px; border: none;
            background: var(--save-btn-bg); color: var(--save-btn-color);
            font-weight: bold; font-size: 16px; cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* ÂΩàË∑≥ÊïàÊûú */
        }
        .btn-save-word:hover { transform: scale(1.05); }
        
        /* Â∑≤ÂÑ≤Â≠òÁãÄÊÖã */
        .btn-save-word.saved {
            background: var(--saved-bg); color: var(--saved-color);
        }
        
        /* ÈªûÊìäÂãïÁï´ */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .animate-pop { animation: pop 0.3s ease; }

        /* Cambridge Button */
        .cambridge-btn {
            background-color: #1d2a57; color: white; border: none; padding: 8px 15px;
            border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 14px;
            display: flex; align-items: center; gap: 5px; transition: 0.2s;
            text-decoration: none;
        }
        .cambridge-btn:hover { background-color: #2e4085; transform: translateY(-2px); }

        .phonetic-group { display: flex; align-items: center; gap: 10px; background: #f3f4f6; padding: 5px 15px; border-radius: 20px; margin-top: 10px; width: fit-content; }
        .definition { font-weight: 600; font-size: 18px; margin-bottom: 5px; margin-top: 10px; }
        .definition::before { content: "‚Ä¢ "; color: var(--primary); }

        /* Exam Overlays */
        .exam-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 300;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .mode-select-box { text-align: center; }
        .mode-btn {
            display: block; width: 200px; padding: 20px; margin: 10px auto;
            border: 2px solid var(--primary); border-radius: 12px; background: white;
            font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        .mode-btn:hover { background: var(--primary); color: white; }
        .exam-box { text-align: center; width: 90%; max-width: 500px; }
        .audio-big-btn {
            width: 100px; height: 100px; border-radius: 50%; background: var(--primary); color: white;
            font-size: 40px; border: none; cursor: pointer; margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(29, 78, 216, 0.3); transition: transform 0.1s;
        }
        .audio-big-btn:active { transform: scale(0.95); }
        .black-box-mask {
            background-color: black; color: black; padding: 10px 20px; border-radius: 8px; user-select: none;
            display: inline-block; font-size: 40px; font-weight: bold; font-family: var(--font-serif); min-width: 200px;
        }
        .revealed { background-color: transparent; color: var(--text-main); }
        .type-input {
            font-size: 32px; text-align: center; padding: 10px; border: none; border-bottom: 3px solid #ddd;
            outline: none; width: 100%; font-family: var(--font-serif); font-weight: bold; text-transform: lowercase;
        }
        .judge-btns { display: none; gap: 20px; justify-content: center; margin-top: 30px; }
        .btn-judge { padding: 15px 30px; font-size: 18px; border-radius: 30px; border: none; cursor: pointer; font-weight: bold; color: white; }
        .btn-yes { background: var(--success); }
        .btn-no { background: var(--error); }
        .result-box { text-align: center; width: 90%; max-width: 600px; }
        .score-circle {
            width: 150px; height: 150px; border-radius: 50%; border: 10px solid var(--primary);
            display: flex; align-items: center; justify-content: center; margin: 0 auto 30px;
            font-size: 40px; font-weight: 900; color: var(--primary);
        }
        .wrong-list { text-align: left; max-height: 300px; overflow-y: auto; background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .wrong-item { border-bottom: 1px solid #ddd; padding: 8px 0; color: var(--error); font-weight: bold; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo">Dictionary</div>
        
        <div class="nav-actions">
            <a href="final_exam.html" class="nav-btn btn-final">Final Exam ‚úàÔ∏è</a>
            <button class="nav-btn" onclick="toggleSidebar()">
                Saved <span class="badge" id="badge-count">0</span>
            </button>
        </div>
    </nav>

    <div class="sidebar" id="sidebar">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <h3 style="margin:0;">Vocabulary</h3>
            <button onclick="toggleSidebar()" style="border:none; background:none; font-size:24px; cursor:pointer;">√ó</button>
        </div>
        
        <div class="project-controls">
            <div class="project-label">üìÅ Current Project (Folder)</div>
            <div class="project-row">
                <select id="project-select" class="project-select" onchange="switchProject()">
                    </select>
                <button class="btn-add-project" onclick="addNewProject()" title="Add New Project">Ôºã</button>
            </div>
        </div>

        <button class="sidebar-btn btn-test" onclick="showExamSetup()">Start Test üéì</button>

        <div id="saved-list" style="flex:1; overflow-y:auto;"></div>
        
        <button onclick="clearAll()" style="color:red; background:none; border:1px solid red; padding:5px; margin-top:10px; cursor:pointer; width:100%; border-radius:4px;">Clear Current List</button>
    </div>

    <div class="container" id="main-view">
        <input type="text" class="search-input" id="word-input" placeholder="Type a word..." onkeydown="if(event.key==='Enter') searchWord()">
        
        <div class="entry-container" id="entry-result">
            <div class="entry-header">
                <div class="word-group">
                    <h1 class="headword" id="disp-word">Word</h1>
                    <button class="btn-save-word" id="btn-save" onclick="toggleSaveWord()">
                        <span id="save-icon">‚ù§Ô∏è</span> <span id="save-text">Save</span>
                    </button>
                </div>
                
                <a href="#" target="_blank" id="cambridge-link" class="cambridge-btn">
                    üá® Cambridge
                </a>
            </div>

            <div class="phonetic-group">
                <span id="disp-phonetic">/ ... /</span>
                <button onclick="playAudio()" style="background:none; border:none; cursor:pointer; font-size:20px;">üîä</button>
            </div>
            <div id="meanings-area"></div>
        </div>
    </div>

    <div class="exam-overlay" id="exam-setup">
        <div class="mode-select-box">
            <h1>Choose Exam Mode</h1>
            <button class="mode-btn" onclick="startExam('listening')">üëÇ Listening Mode<br><span style="font-size:12px; color:#666;">Black box + Self check</span></button>
            <button class="mode-btn" onclick="startExam('typing')">‚å®Ô∏è Typing Mode<br><span style="font-size:12px; color:#666;">Type what you hear</span></button>
            <button onclick="closeExam()" style="margin-top:20px; background:none; border:none; text-decoration:underline; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <div class="exam-overlay" id="exam-active">
        <div class="exam-box">
            <button class="audio-big-btn" onclick="playExamAudio()">üîä</button>
            <div id="mode-listen-area" style="display:none;">
                <div id="listen-black-box" class="black-box-mask">WORD</div>
                <div style="margin-top:40px;"><button id="btn-reveal" onclick="revealListening()" style="padding:10px 30px; font-size:16px; cursor:pointer;">Show Answer</button></div>
                <div class="judge-btns" id="judge-btns">
                    <button class="btn-judge btn-no" onclick="handleJudge(false)">‚ùå Forgot</button>
                    <button class="btn-judge btn-yes" onclick="handleJudge(true)">‚úÖ Correct</button>
                </div>
            </div>
            <div id="mode-type-area" style="display:none;">
                <input type="text" id="type-input" class="type-input" placeholder="Type here..." autocomplete="off" onkeydown="if(event.key==='Enter') checkTyping()">
                <div style="margin-top:20px; color:#999; font-size:14px;">Press Enter to check</div>
            </div>
            <div style="margin-top:30px; color:#ccc;"><span id="q-current">1</span> / <span id="q-total">10</span></div>
            <button onclick="closeExam()" style="margin-top:20px; background:none; border:none; color:#999; cursor:pointer;">Exit</button>
        </div>
    </div>

    <div class="exam-overlay" id="result-view">
        <div class="result-box">
            <h1>Results</h1>
            <div class="score-circle"><span id="result-score">0%</span></div>
            <div style="display:flex; justify-content:space-around; margin-bottom:20px;">
                <div style="color:var(--success); font-weight:bold;">Correct: <span id="res-correct">0</span></div>
                <div style="color:var(--error); font-weight:bold;">Wrong: <span id="res-wrong">0</span></div>
            </div>
            <h3>Mistakes Review</h3>
            <div class="wrong-list" id="wrong-container"></div>
            <button onclick="closeExam()" style="padding:15px 40px; background:var(--primary); color:white; border:none; border-radius:30px; font-size:18px; cursor:pointer;">Close</button>
        </div>
    </div>

    <script>
        // --- State Management ---
        let allWords = JSON.parse(localStorage.getItem('dictWords')) || [];
        // Projects: List of strings. Default has 'General'
        let projectList = JSON.parse(localStorage.getItem('dictProjects')) || ['General'];
        let currentProject = localStorage.getItem('lastProject') || 'General';

        // Current Word Data (for saving)
        let currentWordData = null;

        // Exam State
        let examQueue = [];
        let examIndex = 0;
        let examMode = '';
        let correctCount = 0;
        let wrongWordsList = [];

        // Init
        initProjects();
        renderList();
        
        // --- Project Logic ---
        function initProjects() {
            const select = document.getElementById('project-select');
            select.innerHTML = '';
            projectList.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                if(p === currentProject) opt.selected = true;
                select.appendChild(opt);
            });
        }

        function addNewProject() {
            const name = prompt("Enter new project name:");
            if(name && !projectList.includes(name)) {
                projectList.push(name);
                localStorage.setItem('dictProjects', JSON.stringify(projectList));
                currentProject = name;
                localStorage.setItem('lastProject', name);
                initProjects();
                renderList(); // clear list view for new project
                updateSaveButtonState();
            }
        }

        function switchProject() {
            const select = document.getElementById('project-select');
            currentProject = select.value;
            localStorage.setItem('lastProject', currentProject);
            renderList();
            updateSaveButtonState();
        }

        // --- Dictionary Search ---
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const queryWord = urlParams.get('q');
            if (queryWord) {
                document.getElementById('word-input').value = queryWord;
                searchWord();
            }
        };

        async function searchWord() {
            const input = document.getElementById('word-input');
            const word = input.value.trim();
            if(!word) return;
            
            try {
                const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
                if(!res.ok) throw new Error();
                const data = await res.json();
                const entry = data[0];
                
                // Display Data
                document.getElementById('disp-word').textContent = entry.word;
                document.getElementById('cambridge-link').href = `https://dictionary.cambridge.org/zht/Ë©ûÂÖ∏/Ëã±Ë™û-Êº¢Ë™û-ÁπÅÈ´î/${entry.word}`;
                
                let audioSrc = null;
                const usAudio = entry.phonetics.find(p => p.audio && p.audio.includes('-us.mp3')) || entry.phonetics.find(p => p.audio);
                if(usAudio) audioSrc = usAudio.audio;
                
                // Set Global Current Word Data
                currentWordData = {
                    word: entry.word,
                    audio: audioSrc,
                    phonetic: entry.phonetic || ""
                };

                document.getElementById('disp-phonetic').textContent = entry.phonetic || "";
                document.getElementById('meanings-area').innerHTML = entry.meanings.map(m => 
                    `<div><span style="font-style:italic;color:#666;">${m.partOfSpeech}</span><div class="definition">${m.definitions[0].definition}</div></div>`
                ).join('');

                document.getElementById('entry-result').style.display = 'block';
                input.value = '';

                // Update Button State (Is it saved in current project?)
                updateSaveButtonState();

            } catch(e) { alert("Word not found"); }
        }

        // --- Save / Unsave Logic ---
        function toggleSaveWord() {
            if (!currentWordData) return;

            // Check if exists in CURRENT project
            const existsIndex = allWords.findIndex(w => 
                w.word.toLowerCase() === currentWordData.word.toLowerCase() && 
                (w.project || 'General') === currentProject
            );

            const btn = document.getElementById('btn-save');

            if (existsIndex >= 0) {
                // Already saved -> Remove it? Or just alert?
                // Let's implement toggle (Remove)
                if(confirm(`Remove '${currentWordData.word}' from ${currentProject}?`)) {
                    allWords.splice(existsIndex, 1);
                    localStorage.setItem('dictWords', JSON.stringify(allWords));
                    renderList();
                    updateSaveButtonState();
                }
            } else {
                // Not saved -> Add it
                const newWord = {
                    id: Date.now(),
                    word: currentWordData.word,
                    audio: currentWordData.audio,
                    project: currentProject // Attach project tag
                };
                allWords.unshift(newWord); // Add to top
                localStorage.setItem('dictWords', JSON.stringify(allWords));
                
                // Animation
                btn.classList.add('animate-pop');
                setTimeout(() => btn.classList.remove('animate-pop'), 300);
                
                renderList();
                updateSaveButtonState();
            }
        }

        function updateSaveButtonState() {
            if (!currentWordData) return;
            const btn = document.getElementById('btn-save');
            const icon = document.getElementById('save-icon');
            const text = document.getElementById('save-text');

            // Check existence in CURRENT project
            const exists = allWords.some(w => 
                w.word.toLowerCase() === currentWordData.word.toLowerCase() && 
                (w.project || 'General') === currentProject
            );

            if (exists) {
                btn.classList.add('saved');
                icon.textContent = '‚úÖ';
                text.textContent = 'Saved!';
            } else {
                btn.classList.remove('saved');
                icon.textContent = '‚ù§Ô∏è';
                text.textContent = 'Save';
            }
        }

        // --- Sidebar Logic ---
        function renderList() {
            const el = document.getElementById('saved-list');
            el.innerHTML = '';
            
            // Filter words by Current Project
            const projectWords = allWords.filter(w => (w.project || 'General') === currentProject);
            
            document.getElementById('badge-count').textContent = projectWords.length;

            projectWords.forEach(w => {
                const div = document.createElement('div'); div.className='list-item';
                div.innerHTML=`<span onclick="loadFromList('${w.word}')">${w.word}</span> <span onclick="delWord(${w.id})" style="color:red">√ó</span>`;
                el.appendChild(div);
            });
        }
        
        function loadFromList(w) { document.getElementById('word-input').value=w; searchWord(); toggleSidebar(); }
        
        function delWord(id) {
            allWords = allWords.filter(w => w.id !== id);
            localStorage.setItem('dictWords', JSON.stringify(allWords));
            renderList();
            updateSaveButtonState();
        }

        function clearAll() {
            if(confirm(`Delete ALL words in '${currentProject}'?`)) {
                // Keep words NOT in current project
                allWords = allWords.filter(w => (w.project || 'General') !== currentProject);
                localStorage.setItem('dictWords', JSON.stringify(allWords));
                renderList();
                updateSaveButtonState();
            }
        }

        // --- Other Utils ---
        function playAudio() { if(currentWordData && currentWordData.audio) new Audio(currentWordData.audio).play(); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

        // --- Exam Logic (Filters by Project) ---
        function showExamSetup() {
            // Only test words in current project
            const projectWords = allWords.filter(w => (w.project || 'General') === currentProject);
            
            if(projectWords.length === 0) return alert(`No words in '${currentProject}' to test!`);
            toggleSidebar(); document.getElementById('main-view').style.display = 'none'; document.getElementById('exam-setup').style.display = 'flex';
        }

        function startExam(mode) {
            examMode = mode;
            // Filter queue by project
            const projectWords = allWords.filter(w => (w.project || 'General') === currentProject);
            examQueue = [...projectWords].sort(() => Math.random() - 0.5);
            
            examIndex = 0; correctCount = 0; wrongWordsList = [];
            document.getElementById('exam-setup').style.display = 'none'; document.getElementById('exam-active').style.display = 'flex';
            document.getElementById('mode-listen-area').style.display = (mode === 'listening') ? 'block' : 'none';
            document.getElementById('mode-type-area').style.display = (mode === 'typing') ? 'block' : 'none';
            loadQuestion();
        }
        
        function loadQuestion() {
            if(examIndex >= examQueue.length) { showResults(); return; }
            const currentItem = examQueue[examIndex];
            document.getElementById('q-current').textContent = examIndex + 1; document.getElementById('q-total').textContent = examQueue.length;
            if(examMode === 'listening') {
                const box = document.getElementById('listen-black-box'); box.textContent = currentItem.word; box.classList.remove('revealed');
                document.getElementById('btn-reveal').style.display = 'inline-block'; document.getElementById('judge-btns').style.display = 'none';
            } else {
                const input = document.getElementById('type-input'); input.value = ''; input.focus();
            }
            setTimeout(playExamAudio, 500);
        }
        function playExamAudio() { const item = examQueue[examIndex]; if(item.audio) new Audio(item.audio).play(); }
        function checkTyping() {
            const input = document.getElementById('type-input');
            if(input.value.trim().toLowerCase() === examQueue[examIndex].word.toLowerCase()) { triggerFeedback('success'); correctCount++; }
            else { triggerFeedback('error'); wrongWordsList.push(examQueue[examIndex]); }
            setTimeout(() => { examIndex++; loadQuestion(); }, 1000);
        }
        function revealListening() { document.getElementById('listen-black-box').classList.add('revealed'); document.getElementById('btn-reveal').style.display = 'none'; document.getElementById('judge-btns').style.display = 'flex'; }
        function handleJudge(isCorrect) {
            if(isCorrect) { triggerFeedback('success'); correctCount++; } else { triggerFeedback('error'); wrongWordsList.push(examQueue[examIndex]); }
            setTimeout(() => { examIndex++; loadQuestion(); }, 800);
        }
        function triggerFeedback(type) {
            const className = type === 'success' ? 'glow-success' : 'glow-error'; document.body.classList.add(className);
            setTimeout(() => { document.body.classList.remove(className); }, 800);
        }
        function showResults() {
            document.getElementById('exam-active').style.display = 'none'; document.getElementById('result-view').style.display = 'flex';
            document.getElementById('res-correct').textContent = correctCount; document.getElementById('res-wrong').textContent = wrongWordsList.length;
            document.getElementById('result-score').textContent = (Math.round((correctCount / examQueue.length) * 100) || 0) + '%';
            const container = document.getElementById('wrong-container'); container.innerHTML = '';
            if(wrongWordsList.length === 0) container.innerHTML = '<div style="color:green">Perfect Score! üéâ</div>';
            else wrongWordsList.forEach(w => { const div = document.createElement('div'); div.className = 'wrong-item'; div.textContent = w.word; container.appendChild(div); });
        }
        function closeExam() {
            document.getElementById('exam-setup').style.display = 'none'; document.getElementById('exam-active').style.display = 'none';
            document.getElementById('result-view').style.display = 'none'; document.getElementById('main-view').style.display = 'block';
        }
    </script>
</body>
</html>
