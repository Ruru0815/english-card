<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Dictionary & Exam Suite</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #1d4ed8;
            --secondary: #f1f5f9;
            --text-main: #111827;
            --success: #22c55e;
            --error: #ef4444;
            --save-btn-bg: #e2e8f0;
            --save-btn-color: #64748b;
            --saved-bg: #dcfce7;
            --saved-color: #15803d;
            --font-serif: 'Merriweather', serif;
            --font-sans: 'Segoe UI', Roboto, sans-serif;
        }

        body {
            font-family: var(--font-sans);
            margin: 0;
            background-color: #fff;
            color: var(--text-main);
            height: 100vh;
            overflow-x: hidden;
            transition: box-shadow 0.3s ease;
        }

        .glow-success { box-shadow: inset 0 0 50px var(--success) !important; }
        .glow-error { box-shadow: inset 0 0 50px var(--error) !important; }

        /* Clock */
        .system-clock {
            position: fixed; bottom: 15px; left: 20px; font-family: monospace; font-size: 16px;
            color: #94a3b8; background: rgba(255, 255, 255, 0.9); padding: 5px 10px;
            border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 900;
        }

        /* Navbar */
        .navbar {
            background: #fff; border-bottom: 1px solid #e5e7eb; padding: 15px 40px;
            display: flex; justify-content: space-between; align-items: center;
            position: fixed; top: 0; width: 100%; box-sizing: border-box; z-index: 100;
        }
        .logo { font-family: var(--font-serif); font-weight: 900; font-size: 24px; color: var(--primary); }
        .nav-actions { display: flex; align-items: center; gap: 12px; }
        .nav-btn {
            background: white; border: 1px solid #e5e7eb; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;
            display: flex; align-items: center; gap: 8px; transition: all 0.2s; font-size: 14px; text-decoration: none; color: var(--text-main);
        }
        .nav-btn:hover { background: var(--secondary); }
        .btn-final { background-color: #eab308; color: black; border: 1px solid #ca8a04; }
        .btn-final:hover { background-color: #ca8a04; }
        .badge { background: var(--primary); color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; }

        /* Login Button */
        .btn-login { background-color: #2563eb; color: white; border: none; }
        .btn-login:hover { background-color: #1d4ed8; }
        .user-info { font-size: 14px; color: #666; font-weight: bold; margin-right: 10px; }

        /* Sidebar */
        .sidebar {
            position: fixed; top: 0; right: -350px; width: 320px; height: 100vh; background: #f9fafb;
            border-left: 1px solid #e5e7eb; transition: right 0.3s ease; z-index: 200;
            display: flex; flex-direction: column; padding: 20px; box-sizing: border-box;
            box-shadow: -5px 0 15px rgba(0,0,0,0.05);
        }
        .sidebar.open { right: 0; }
        
        .project-controls { background: white; border: 1px solid #e5e7eb; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        .project-label { font-size: 12px; color: #666; margin-bottom: 5px; font-weight: bold; }
        .project-row { display: flex; gap: 5px; }
        .project-select { flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 4px; outline: none; font-size: 14px; }
        .btn-add-project { padding: 5px 10px; background: var(--secondary); border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        .sidebar-btn { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 10px; display: block; text-align: center; text-decoration: none; font-size: 14px; }
        .btn-test { background: var(--text-main); color: white; }
        .list-item { background: white; border: 1px solid #e5e7eb; padding: 10px; margin-bottom: 8px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; }

        /* Main View */
        .container { margin-top: 80px; max-width: 800px; margin-left: auto; margin-right: auto; padding: 20px; }
        .search-input { width: 100%; padding: 20px; font-size: 20px; border: 2px solid #e5e7eb; border-radius: 8px; outline: none; margin-bottom: 30px; box-sizing: border-box; }
        
        /* Daily Word Card */
        .daily-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #bae6fd;
            border-radius: 12px; padding: 20px; margin-bottom: 30px; position: relative; overflow: hidden;
            display: none; animation: fadeIn 0.5s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
        .daily-card h3 { margin: 0 0 10px 0; color: #0284c7; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        .daily-word { font-size: 24px; font-weight: bold; color: #0c4a6e; margin-bottom: 5px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .daily-def { font-size: 16px; color: #334155; margin-bottom: 5px; }
        .daily-ex { font-style: italic; color: #64748b; font-size: 14px; border-left: 3px solid #7dd3fc; padding-left: 10px; margin-top: 10px; }

        /* Entry Result */
        .entry-container { display: none; margin-top: 10px; }
        .entry-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .word-group { display: flex; align-items: center; gap: 15px; }
        .headword { font-family: var(--font-serif); font-size: 48px; font-weight: 700; margin: 0; }
        
        .btn-save-word {
            display: flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 20px; border: none;
            background: var(--save-btn-bg); color: var(--save-btn-color); font-weight: bold; font-size: 16px; cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .btn-save-word:hover { transform: scale(1.05); }
        .btn-save-word.saved { background: var(--saved-bg); color: var(--saved-color); }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .animate-pop { animation: pop 0.3s ease; }

        .cambridge-btn {
            background-color: #1d2a57; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer;
            font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 5px; transition: 0.2s; text-decoration: none;
        }
        .cambridge-btn:hover { background-color: #2e4085; transform: translateY(-2px); }

        .phonetic-group { display: flex; align-items: center; gap: 10px; background: #f3f4f6; padding: 5px 15px; border-radius: 20px; margin-top: 10px; width: fit-content; }
        .definition { font-weight: 600; font-size: 18px; margin-bottom: 5px; margin-top: 10px; }
        .definition::before { content: "‚Ä¢ "; color: var(--primary); }

        /* Login Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 1000; display: none; align-items: center; justify-content: center;
        }
        .modal-box { background: white; padding: 30px; border-radius: 12px; width: 300px; text-align: center; }
        .modal-input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .modal-btn { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        .modal-link { color: #666; cursor: pointer; font-size: 12px; margin-top: 15px; display: block; text-decoration: underline; }
        
        /* ÈåØË™§Ë®äÊÅØÊ®£Âºè */
        .error-msg {
            color: var(--error); font-size: 14px; margin-top: 5px; display: none; font-weight: bold;
        }

        /* Exam Overlays */
        .exam-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 300;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .mode-select-box { text-align: center; }
        .mode-btn {
            display: block; width: 220px; padding: 20px; margin: 10px auto;
            border: 2px solid var(--primary); border-radius: 12px; background: white;
            font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        .mode-btn:hover { background: var(--primary); color: white; }
        .exam-box { text-align: center; width: 90%; max-width: 500px; }
        
        .audio-big-btn {
            width: 120px; height: 120px; border-radius: 50%; background: var(--primary); color: white;
            font-size: 50px; border: none; cursor: pointer; margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(29, 78, 216, 0.4); transition: transform 0.1s;
        }
        .audio-big-btn:active { transform: scale(0.95); }
        
        .black-box-mask {
            background-color: black; color: black; padding: 10px 20px; border-radius: 8px; user-select: none;
            display: inline-block; font-size: 40px; font-weight: bold; font-family: var(--font-serif); min-width: 200px;
        }
        .revealed { background-color: transparent; color: var(--text-main); }

        .type-input {
            font-size: 32px; text-align: center; padding: 10px; border: none; border-bottom: 3px solid #ddd;
            outline: none; width: 100%; font-family: var(--font-serif); font-weight: bold; text-transform: lowercase;
        }
        .judge-btns { display: none; gap: 20px; justify-content: center; margin-top: 30px; }
        .btn-judge { padding: 15px 30px; font-size: 18px; border-radius: 30px; border: none; cursor: pointer; font-weight: bold; color: white; }
        .btn-yes { background: var(--success); }
        .btn-no { background: var(--error); }

        .result-box {
            text-align: center; width: 90%; max-width: 600px; background: white; border-radius: 20px; padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-height: 90vh; display: flex; flex-direction: column;
        }
        .score-circle {
            width: 120px; height: 120px; border-radius: 50%; border: 8px solid var(--primary);
            display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;
            font-size: 32px; font-weight: 900; color: var(--primary); flex-shrink: 0;
        }
        .wrong-list {
            text-align: left; overflow-y: auto; background: #f8fafc; padding: 15px; border-radius: 12px;
            margin-bottom: 20px; flex: 1; min-height: 100px; max-height: 40vh; border: 1px solid #e2e8f0;
        }
        .wrong-item { border-bottom: 1px solid #ddd; padding: 10px 0; display:flex; justify-content: space-between; align-items: center; }
        .user-ans { color: var(--error); text-decoration: line-through; margin-right: 10px; font-size: 14px;}
        .correct-ans { color: var(--success); font-weight: bold; }
    </style>
</head>
<body>

    <div class="system-clock" id="sys-clock">2025-01-01 00:00:00</div>

    <div class="modal-overlay" id="login-modal">
        <div class="modal-box">
            <h2>üîê Log In</h2>
            <input type="email" id="email" class="modal-input" placeholder="Email">
            <input type="password" id="password" class="modal-input" placeholder="Password">
            
            <div id="login-error" class="error-msg">Â∏≥ËôüÊàñÂØÜÁ¢ºÊúâË™§ÔºåË´ãÂÜçËº∏ÂÖ•‰∏ÄÊ¨°</div>
            
            <button class="modal-btn" onclick="handleAuth()">Submit</button>
            <div class="modal-link" onclick="closeLogin()">Cancel</div>
        </div>
    </div>

    <nav class="navbar">
        <div class="logo">Dictionary</div>
        <div class="nav-actions">
            <span id="user-display" class="user-info"></span>
            
            <button id="auth-btn" class="nav-btn btn-login" onclick="openLogin()">Log In</button>
            
            <a href="final_exam.html" id="nav-btn-final" class="nav-btn btn-final auth-only">Final Exam ‚úàÔ∏è</a>
            <button id="nav-btn-saved" class="nav-btn auth-only" onclick="toggleSidebar()">
                Saved <span class="badge" id="badge-count">0</span>
            </button>
        </div>
    </nav>

    <div class="sidebar" id="sidebar">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <h3 style="margin:0;">Vocabulary</h3>
            <button onclick="toggleSidebar()" style="border:none; background:none; font-size:24px; cursor:pointer;">√ó</button>
        </div>
        
        <div class="project-controls">
            <div class="project-label">üìÅ Current Project</div>
            <div class="project-row">
                <select id="project-select" class="project-select" onchange="switchProject()"></select>
                <button class="btn-add-project" onclick="addNewProject()" title="Add New Project">Ôºã</button>
            </div>
        </div>

        <button class="sidebar-btn btn-test" onclick="showExamSetup()">Start Test üéì</button>

        <div id="saved-list" style="flex:1; overflow-y:auto;"></div>
        <button onclick="clearAll()" style="color:red; background:none; border:1px solid red; padding:5px; margin-top:10px; cursor:pointer; width:100%; border-radius:4px;">Clear Current List</button>
    </div>

    <div class="container" id="main-view">
        <input type="text" class="search-input" id="word-input" placeholder="Type a word..." onkeydown="if(event.key==='Enter') searchWord()">

        <div class="daily-card" id="daily-card">
            <h3>üåü Daily Word (Resets at 00:00)</h3>
            <div class="daily-word" id="dw-word" onclick="searchDaily()">
                <span>Loading...</span>
            </div>
            <div class="daily-def" id="dw-def"></div>
            <div class="daily-ex" id="dw-ex"></div>
        </div>
        
        <div class="entry-container" id="entry-result">
            <div class="entry-header">
                <div class="word-group">
                    <h1 class="headword" id="disp-word">Word</h1>
                    <button class="btn-save-word auth-only" id="btn-save" onclick="toggleSaveWord()">
                        <span id="save-icon">‚ù§Ô∏è</span> <span id="save-text">Save</span>
                    </button>
                </div>
                <a href="#" target="_blank" id="cambridge-link" class="cambridge-btn">üá® Cambridge</a>
            </div>

            <div class="phonetic-group">
                <span id="disp-phonetic">/ ... /</span>
                <button onclick="playAudio()" style="background:none; border:none; cursor:pointer; font-size:20px;">üîä</button>
            </div>
            <div id="meanings-area"></div>
        </div>
    </div>

    <div class="exam-overlay" id="exam-setup">
        <div class="mode-select-box">
            <h1>Choose Exam Mode</h1>
            <button class="mode-btn" onclick="startExam('listening')">üëÇ Listening Mode<br><span style="font-size:12px; color:#666;">Black box + Self check</span></button>
            <button class="mode-btn" onclick="startExam('typing')">‚å®Ô∏è Typing Mode<br><span style="font-size:12px; color:#666;">Type & Check at end</span></button>
            <button onclick="closeExam()" style="margin-top:20px; background:none; border:none; text-decoration:underline; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <div class="exam-overlay" id="exam-active">
        <div class="exam-box">
            <button class="audio-big-btn" onclick="playExamAudio()">üîä</button>
            
            <div id="mode-listen-area" style="display:none;">
                <div id="listen-black-box" class="black-box-mask">WORD</div>
                <div style="margin-top:40px;"><button id="btn-reveal" onclick="revealListening()" style="padding:10px 30px; font-size:16px; cursor:pointer;">Show Answer</button></div>
                <div class="judge-btns" id="judge-btns">
                    <button class="btn-judge btn-no" onclick="handleJudge(false)">‚ùå Forgot</button>
                    <button class="btn-judge btn-yes" onclick="handleJudge(true)">‚úÖ Correct</button>
                </div>
            </div>

            <div id="mode-type-area" style="display:none;">
                <input type="text" id="type-input" class="type-input" placeholder="Type answer..." autocomplete="off" onkeydown="if(event.key==='Enter') checkTypingStrict()">
                <div style="margin-top:20px; color:#999; font-size:14px;">Press Enter to submit</div>
            </div>

            <div style="margin-top:30px; color:#ccc;"><span id="q-current">1</span> / <span id="q-total">10</span></div>
            <button onclick="closeExam()" style="margin-top:20px; background:none; border:none; color:#999; cursor:pointer;">Exit</button>
        </div>
    </div>

    <div class="exam-overlay" id="result-view">
        <div class="result-box">
            <h1>Exam Results</h1>
            <div class="score-circle"><span id="result-score">0%</span></div>
            <div style="display:flex; justify-content:space-around; margin-bottom:20px;">
                <div style="color:var(--success); font-weight:bold;">Correct: <span id="res-correct">0</span></div>
                <div style="color:var(--error); font-weight:bold;">Wrong: <span id="res-wrong">0</span></div>
            </div>
            <h3>Report</h3>
            <div class="wrong-list" id="wrong-container"></div>
            <button onclick="closeExam()" style="padding:15px 40px; background:var(--primary); color:white; border:none; border-radius:30px; font-size:18px; cursor:pointer;">Close</button>
        </div>
    </div>

    <script>
        // ==========================================
        //  FIREBASE CONFIGURATION (Ë´ãÂ°´ÂÖ•‰Ω†ÁöÑÈáëÈë∞)
        // ==========================================
        const firebaseConfig = {
  apiKey: "AIzaSyChbDqFtc7ekxYUw4_ONqqitYxQ-dYXUBU",
  authDomain: "myenglishcard-a2fb5.firebaseapp.com",
  projectId: "myenglishcard-a2fb5",
  storageBucket: "myenglishcard-a2fb5.firebasestorage.app",
  messagingSenderId: "474910165570",
  appId: "1:474910165570:web:21cc9267e244d6868b7bdb",
  measurementId: "G-0E0T4CSMWV"
};
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ==========================================
        //  APP STATE
        // ==========================================
        let currentUser = null;
        let allWords = [];
        let projectList = ['General'];
        let currentProject = 'General';
        let currentWordData = null;

        // Exam State
        let examQueue = [];
        let examIndex = 0;
        let examMode = '';
        let correctCount = 0;
        let wrongWordsList = [];
        let strictResults = []; 

        const dailyVocabulary = [
            "ambitious", "benefit", "circumstance", "distinct", "elaborate", "fascinate", "genuine", "hostile", "inevitable", "justify",
            "knowledge", "leisure", "maintain", "negotiate", "obstacle", "potential", "qualify", "relevant", "significant", "tolerate",
            "urgent", "valid", "wealth", "yield", "zeal", "abundant", "brief", "capacity", "debate", "efficient", "flexible",
            "generate", "hesitate", "identify", "jeopardy", "keen", "logic", "modify", "notion", "optimistic", "precise", "quote",
            "recommend", "strategy", "tendency", "ultimate", "venture", "widespread", "adapt", "budget", "candidate", "decade",
            "emphasize", "finance", "global", "habitat", "impact", "joint", "landscape", "marvel", "native", "objective", "perceive",
            "rapid", "severe", "theory", "unique", "vital", "witness", "access", "barrier", "career", "deposit", "element", "factor",
            "growth", "highlight", "income", "justice", "key", "launch", "mention", "network", "option", "phase", "range", "sector",
            "target", "union", "volume"
        ];

        // --- Init ---
        updateTime();
        setInterval(updateTime, 1000);
        
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const queryWord = urlParams.get('q');
            if (queryWord) {
                document.getElementById('word-input').value = queryWord;
                searchWord();
            } else {
                loadDailyWord(); 
            }
        };

        // --- Auth Logic ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('user-display').textContent = user.email;
                document.getElementById('auth-btn').textContent = "Log Out";
                document.getElementById('auth-btn').onclick = logout;
                document.getElementById('login-modal').style.display = 'none';
                document.querySelectorAll('.auth-only').forEach(el => el.style.display = '');
                loadUserData();
            } else {
                currentUser = null;
                document.getElementById('user-display').textContent = "";
                document.getElementById('auth-btn').textContent = "Log In";
                document.getElementById('auth-btn').onclick = openLogin;
                document.querySelectorAll('.auth-only').forEach(el => el.style.display = 'none');
                allWords = []; projectList = ['General'];
                renderList(); initProjects();
                document.getElementById('sidebar').classList.remove('open');
            }
        });

        function loadUserData() {
            db.collection('users').doc(currentUser.uid).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    allWords = data.words || [];
                    projectList = data.projects || ['General'];
                    renderList(); initProjects();
                } else { saveUserData(); }
            });
        }

        function saveUserData() {
            if (!currentUser) return;
            db.collection('users').doc(currentUser.uid).set({ words: allWords, projects: projectList });
        }

        // Login Logic with Error Handling
        function openLogin() { 
            document.getElementById('login-modal').style.display = 'flex'; 
            document.getElementById('login-error').style.display = 'none'; // reset error
            document.getElementById('password').value = ''; 
        }
        function closeLogin() { document.getElementById('login-modal').style.display = 'none'; }
        
        function handleAuth() {
            const email = document.getElementById('email').value;
            const passInput = document.getElementById('password');
            const pass = passInput.value;
            const errorMsg = document.getElementById('login-error');

            errorMsg.style.display = 'none'; // hide previous error

            auth.signInWithEmailAndPassword(email, pass)
                .catch(e => {
                    // Login Failed
                    errorMsg.style.display = 'block'; // show error
                    passInput.value = ''; // clear password
                    passInput.focus();
                });
        }
        function logout() { auth.signOut(); }

        // --- Normal Logic ---
        function updateTime() {
            const now = new Date();
            const format = (n) => n.toString().padStart(2, '0');
            const str = `${now.getFullYear()}-${format(now.getMonth()+1)}-${format(now.getDate())} ${format(now.getHours())}:${format(now.getMinutes())}:${format(now.getSeconds())}`;
            document.getElementById('sys-clock').textContent = str;
        }

        async function loadDailyWord() {
            const now = new Date();
            const todayStr = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
            let record = JSON.parse(localStorage.getItem('daily_word_record'));
            let targetWord = "";

            if (record && record.date === todayStr) targetWord = record.word;
            else {
                targetWord = dailyVocabulary[Math.floor(Math.random() * dailyVocabulary.length)];
                localStorage.setItem('daily_word_record', JSON.stringify({ date: todayStr, word: targetWord }));
            }
            
            try {
                const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${targetWord}`);
                if(!res.ok) return;
                const data = await res.json();
                const entry = data[0];
                const def = entry.meanings[0].definitions[0].definition;
                const ex = entry.meanings[0].definitions[0].example || "No example sentence available.";

                document.getElementById('daily-card').style.display = 'block';
                document.getElementById('dw-word').innerHTML = `<span>${entry.word}</span> <small style="font-size:14px; color:#666;">(${entry.meanings[0].partOfSpeech})</small>`;
                document.getElementById('dw-def').textContent = def;
                document.getElementById('dw-ex').textContent = `"${ex}"`;
                document.getElementById('dw-word').onclick = () => { document.getElementById('word-input').value = entry.word; searchWord(); }
            } catch(e) {}
        }
        function searchDaily() { /* Handled inline */ }

        function initProjects() {
            const select = document.getElementById('project-select'); select.innerHTML = '';
            projectList.forEach(p => {
                const opt = document.createElement('option'); opt.value = p; opt.textContent = p;
                if(p === currentProject) opt.selected = true; select.appendChild(opt);
            });
        }
        function addNewProject() {
            const name = prompt("Enter new project name:");
            if(name && !projectList.includes(name)) {
                projectList.push(name); saveUserData();
                currentProject = name; initProjects(); renderList(); updateSaveButtonState();
            }
        }
        function switchProject() {
            currentProject = document.getElementById('project-select').value;
            renderList(); updateSaveButtonState();
        }

        async function searchWord() {
            const input = document.getElementById('word-input');
            const word = input.value.trim();
            if(!word) return;
            
            // Èö±ËóèÊØèÊó•ÂñÆÂ≠óÂç°
            document.getElementById('daily-card').style.display = 'none';

            try {
                const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
                
                // --- ÈóúÈçµ‰øÆÊîπÔºöÂ¶ÇÊûú API Êâæ‰∏çÂà∞ (404)Ôºå‰∏çË∑≥Âá∫ÈåØË™§ÔºåËÄåÊòØÈÄ≤ÂÖ•„ÄåÊâãÂãïÂª∫Á´ãÊ®°Âºè„Äç ---
                if(!res.ok) {
                    throw new Error("API_MISSING");
                }

                const data = await res.json();
                
                // 1. ÂòóË©¶ÊâæÁæéÂºèÁôºÈü≥
                let audioSrc = null;
                for(const entry of data) {
                    const us = entry.phonetics.find(p => p.audio && p.audio.includes('-us.mp3'));
                    if(us) { audioSrc = us.audio; break; }
                }
                // 2. Â¶ÇÊûúÊ≤íÁæéÂºèÔºåÊâæ‰ªªÊÑèÁôºÈü≥
                if(!audioSrc) {
                    for(const entry of data) {
                        const any = entry.phonetics.find(p => p.audio);
                        if(any) { audioSrc = any.audio; break; }
                    }
                }

                const entry = data[0];
                renderWordResult(entry.word, entry.phonetic || "", audioSrc, entry.meanings);

            } catch(e) {
                // --- ÈÄôË£°ËôïÁêÜ„ÄåÊü•‰∏çÂà∞„ÄçÁöÑÊÉÖÊ≥Å ---
                console.log("Word not found in API, using fallback.");
                
                // ÈõñÁÑ∂ API Êü•‰∏çÂà∞ÔºåÊàëÂÄëÈÇÑÊòØÂº∑Âà∂È°ØÁ§∫ÈÄôÂÄãÂñÆÂ≠ó
                // ÈÄôÊ®£‰Ω†Â∞±ÂèØ‰ª•Â≠òÊ™î„ÄÅÁôºÈü≥(Áî®Ê©üÂô®‰∫∫)„ÄÅËÄÉË©¶‰∫Ü
                renderWordResult(
                    word, 
                    "(No phonetic)", 
                    null, // Ê≤íÊúâ API Èü≥Ê™îÔºåplayAudio ÊúÉËá™ÂãïËΩâÁî®Ê©üÂô®‰∫∫
                    []    // Ê≤íÊúâËß£ÈáãÔºåUI ÊúÉÈ°ØÁ§∫È†êË®≠ÊñáÂ≠ó
                );
            }
            
            input.value = '';
        }

        // --- ËºîÂä©ÂáΩÂºèÔºöË≤†Ë≤¨ÊääÂñÆÂ≠óÁï´Âú®Ëû¢Âπï‰∏ä ---
        function renderWordResult(wordText, phoneticText, audioSrc, meanings) {
            // 1. È°ØÁ§∫ÂñÆÂ≠óËàáÈü≥Ê®ô
            document.getElementById('disp-word').textContent = wordText;
            document.getElementById('disp-phonetic').textContent = phoneticText;
            
            // 2. Êõ¥Êñ∞ÂäçÊ©ãÂ≠óÂÖ∏ÈÄ£Áµê (ËÆì‰Ω†ÂèØ‰ª•ÂéªÊü•Ë©≥Á¥∞ÊÑèÊÄù)
            document.getElementById('cambridge-link').href = `https://dictionary.cambridge.org/zht/Ë©ûÂÖ∏/Ëã±Ë™û-Êº¢Ë™û-ÁπÅÈ´î/${wordText}`;
            
            // 3. Ë®≠ÂÆöÂÖ®ÂüüËÆäÊï∏ (ËÆìÂÑ≤Â≠òÂäüËÉΩÁü•ÈÅìÁèæÂú®ÊòØÂì™ÂÄãÂ≠ó)
            currentWordData = { 
                word: wordText, 
                audio: audioSrc, 
                phonetic: phoneticText 
            };

            // 4. È°ØÁ§∫Ëß£Èáã (Â¶ÇÊûúÊ≤íÊúâËß£ÈáãÔºåÈ°ØÁ§∫ÊèêÁ§∫ÊñáÂ≠ó)
            const meaningsContainer = document.getElementById('meanings-area');
            if (meanings && meanings.length > 0) {
                meaningsContainer.innerHTML = meanings.map(m => 
                    `<div><span style="font-style:italic;color:#666;">${m.partOfSpeech}</span><div class="definition">${m.definitions[0].definition}</div></div>`
                ).join('');
            } else {
                meaningsContainer.innerHTML = `<div style="color:#666; margin-top:10px;">‚ö†Ô∏è API Êü•ÁÑ°Ê≠§Â≠óË©≥Ëß£„ÄÇ<br>‰ΩÜ‰Ω†‰ªçÂèØ<b>ÂÑ≤Â≠ò</b>Ê≠§Â≠óÔºå‰∏¶‰ΩøÁî®<b>Ê©üÂô®‰∫∫ÁôºÈü≥</b>ÔºåÊàñÈªûÊìä‰∏äÊñπÊåâÈàïÂâçÂæÄÂäçÊ©ãÂ≠óÂÖ∏Êü•Ë©¢„ÄÇ</div>`;
            }

            // 5. È°ØÁ§∫ÁµêÊûúÂçÄÂ°ä‰∏¶Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            document.getElementById('entry-result').style.display = 'block';
            if(currentUser) updateSaveButtonState();
        }

        function toggleSaveWord() {
            if (!currentUser) return;
            if (!currentWordData) return;
            const existsIndex = allWords.findIndex(w => w.word.toLowerCase() === currentWordData.word.toLowerCase() && (w.project || 'General') === currentProject);
            const btn = document.getElementById('btn-save');

            if (existsIndex >= 0) {
                if(confirm(`Remove '${currentWordData.word}'?`)) {
                    allWords.splice(existsIndex, 1);
                    saveUserData(); renderList(); updateSaveButtonState();
                }
            } else {
                const newWord = { id: Date.now(), word: currentWordData.word, audio: currentWordData.audio, project: currentProject };
                allWords.unshift(newWord);
                saveUserData();
                btn.classList.add('animate-pop'); setTimeout(() => btn.classList.remove('animate-pop'), 300);
                renderList(); updateSaveButtonState();
            }
        }
        function updateSaveButtonState() {
            if (!currentWordData) return;
            const btn = document.getElementById('btn-save');
            const icon = document.getElementById('save-icon');
            const text = document.getElementById('save-text');
            const exists = allWords.some(w => w.word.toLowerCase() === currentWordData.word.toLowerCase() && (w.project || 'General') === currentProject);
            if (exists) { btn.classList.add('saved'); icon.textContent = '‚úÖ'; text.textContent = 'Saved!'; } 
            else { btn.classList.remove('saved'); icon.textContent = '‚ù§Ô∏è'; text.textContent = 'Save'; }
        }

        function renderList() {
            const el = document.getElementById('saved-list'); el.innerHTML = '';
            const projectWords = allWords.filter(w => (w.project || 'General') === currentProject);
            document.getElementById('badge-count').textContent = projectWords.length;
            projectWords.forEach(w => {
                const div = document.createElement('div'); div.className='list-item';
                div.innerHTML=`<span onclick="loadFromList('${w.word}')">${w.word}</span> <span onclick="delWord(${w.id})" style="color:red">√ó</span>`;
                el.appendChild(div);
            });
        }
        function loadFromList(w) { document.getElementById('word-input').value=w; searchWord(); toggleSidebar(); }
        function delWord(id) { allWords = allWords.filter(w => w.id !== id); saveUserData(); renderList(); updateSaveButtonState(); }
        function clearAll() { if(confirm(`Delete ALL words in '${currentProject}'?`)) { allWords = allWords.filter(w => (w.project || 'General') !== currentProject); saveUserData(); renderList(); updateSaveButtonState(); } }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function playAudio() { 
            if(currentWordData && currentWordData.audio) new Audio(currentWordData.audio).play(); 
            else if(currentWordData) { const u = new SpeechSynthesisUtterance(currentWordData.word); u.lang='en-US'; window.speechSynthesis.speak(u); } 
        }

        // --- EXAM LOGIC ---
        function showExamSetup() {
            const projectWords = allWords.filter(w => (w.project || 'General') === currentProject);
            if(projectWords.length === 0) return alert(`No words in '${currentProject}' to test!`);
            toggleSidebar(); document.getElementById('main-view').style.display = 'none'; document.getElementById('exam-setup').style.display = 'flex';
        }

        function startExam(mode) {
            examMode = mode;
            const projectWords = allWords.filter(w => (w.project || 'General') === currentProject);
            examQueue = [...projectWords].sort(() => Math.random() - 0.5);
            examIndex = 0; correctCount = 0; 
            wrongWordsList = []; strictResults = [];

            document.getElementById('exam-setup').style.display = 'none'; document.getElementById('exam-active').style.display = 'flex';
            document.getElementById('mode-listen-area').style.display = (mode === 'listening') ? 'block' : 'none';
            document.getElementById('mode-type-area').style.display = (mode === 'typing') ? 'block' : 'none';
            loadQuestion();
        }
        
        function loadQuestion() {
            if(examIndex >= examQueue.length) { showResults(); return; }
            const currentItem = examQueue[examIndex];
            document.getElementById('q-current').textContent = examIndex + 1; document.getElementById('q-total').textContent = examQueue.length;
            
            if(examMode === 'listening') {
                const box = document.getElementById('listen-black-box'); box.textContent = currentItem.word; box.classList.remove('revealed');
                document.getElementById('btn-reveal').style.display = 'inline-block'; document.getElementById('judge-btns').style.display = 'none';
            } else {
                const input = document.getElementById('type-input'); input.value = ''; input.focus();
            }
            setTimeout(playExamAudio, 500);
        }

        function playExamAudio() { 
            const item = examQueue[examIndex]; 
            if(item.audio) new Audio(item.audio).play(); 
            else { const u = new SpeechSynthesisUtterance(item.word); u.lang='en-US'; window.speechSynthesis.speak(u); }
        }

        function checkTypingStrict() {
            const input = document.getElementById('type-input');
            const userVal = input.value.trim();
            const correctVal = examQueue[examIndex].word;
            const isCorrect = (userVal.toLowerCase() === correctVal.toLowerCase());
            if(isCorrect) correctCount++;
            strictResults.push({ word: correctVal, userAns: userVal, isCorrect: isCorrect });
            examIndex++; loadQuestion();
        }

        function revealListening() { document.getElementById('listen-black-box').classList.add('revealed'); document.getElementById('btn-reveal').style.display = 'none'; document.getElementById('judge-btns').style.display = 'flex'; }
        function handleJudge(isCorrect) {
            if(isCorrect) correctCount++; else wrongWordsList.push(examQueue[examIndex]); 
            setTimeout(() => { examIndex++; loadQuestion(); }, 500);
        }

        function showResults() {
            document.getElementById('exam-active').style.display = 'none'; document.getElementById('result-view').style.display = 'flex';
            document.getElementById('result-score').textContent = (Math.round((correctCount / examQueue.length) * 100) || 0) + '%';
            document.getElementById('res-correct').textContent = correctCount;
            document.getElementById('res-wrong').textContent = examQueue.length - correctCount;

            const container = document.getElementById('wrong-container'); container.innerHTML = '';
            
            if(examMode === 'listening') {
                if(wrongWordsList.length === 0) container.innerHTML = '<div style="color:green">Perfect Score! üéâ</div>';
                else wrongWordsList.forEach(w => {
                    const div = document.createElement('div'); div.className = 'wrong-item';
                    div.innerHTML = `<span class="correct-ans">${w.word}</span>`;
                    container.appendChild(div);
                });
            } else {
                strictResults.forEach(r => {
                    const div = document.createElement('div'); div.className = 'wrong-item';
                    if(r.isCorrect) div.innerHTML = `<span class="correct-ans">‚úÖ ${r.word}</span>`;
                    else div.innerHTML = `<div><span class="correct-ans">${r.word}</span><br><span class="user-ans">Your ans: ${r.userAns || "(empty)"}</span></div>`;
                    container.appendChild(div);
                });
            }
        }

        function closeExam() {
            document.getElementById('exam-setup').style.display = 'none'; document.getElementById('exam-active').style.display = 'none';
            document.getElementById('result-view').style.display = 'none'; document.getElementById('main-view').style.display = 'block';
        }
    </script>
</body>
</html>

